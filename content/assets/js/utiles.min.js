if(!base_url||"string"!=typeof base_url)try{const e=new URL(window.location.href),t=e.pathname.replace(/^\/|\/$/g,"").split("/").filter(Boolean);base_url=`${e.protocol}//${e.host}/${encodeURIComponent(t[0]||"")}/`}catch(e){base_url="/"}let debounceTimer;function debounce(e,t){clearTimeout(debounceTimer),debounceTimer=setTimeout((()=>{e()}),t)}function aplicarDebounceABusqueda(e,t=500){$("div.dt-search input").off("input.dt").on("input.dt",(function(){const n=this.value;debounce((()=>{e.search(n).draw()}),t)}))}function fixUrl(e){try{if("string"!=typeof e||!e.trim())return"";if(/^https?:\/\//i.test(e)||"undefined"==typeof base_url)return e;if("string"!=typeof base_url||!base_url.trim())return e;const t=base_url.replace(/\/+$/,"");return`${t}/index.php/${e.replace(/^\/+/,"")}`}catch(e){return""}}function redirectTo(e){setTimeout((function(){window.location.href=fixUrl(e)}),0)}function openInNew(e){window.open(fixUrl(e),"_new")}function redirectByPost(e,t={},n=!0){try{if("string"!=typeof e||!e.trim())return!1;const r=crearFormulario(fixUrl(e),t,n);return document.body.appendChild(r),r.submit(),document.body.removeChild(r),!0}catch(e){return!1}}function crearFormulario(e,t,n){const r=document.createElement("form");return r.method="post",r.action=e,n&&(r.target="_blank"),"undefined"!=typeof csrfToken&&agregarCampoOculto(r,"csrf_token",csrfToken),Object.entries(t).forEach((([e,t])=>{agregarCampoOculto(r,e,String(t))})),r}function agregarCampoOculto(e,t,n){const r=document.createElement("input");r.type="hidden",r.name=t,r.value=n,e.appendChild(r)}function trim(e){return e.trim()}function refreshPage(){location.reload()}function serializeForm(e){return e instanceof HTMLFormElement?Object.fromEntries(new FormData(e)):{}}function shakeElement(e){e instanceof jQuery&&(e=e[0]),e.classList.add("shake"),setTimeout((()=>e.classList.remove("shake")),400)}function ponTotalesEnTabla(e,t=!0,n=!1){if(!(e&&(e instanceof HTMLTableElement||e instanceof jQuery)))return;e instanceof jQuery&&(e=e[0]);const r=e.querySelector("tbody"),o=Array.from(r.querySelectorAll("tr"));let a=o[0]?o[0].querySelectorAll("td").length:0;n&&(agregarColumnaTotal(e,o,a),a+=1),t&&agregarRenglonTotal(r,o,a)}function agregarRenglonTotal(e,t,n){if(t.length<1)return;const r=document.createElement("tr");for(let e=0;e<n;e++){const n=document.createElement("td");n.classList.add("total"),n.style.fontWeight="bold",n.textContent=0===e?"Total":calcularColumnaTotal(t,e),r.appendChild(n)}e.appendChild(r)}function agregarColumnaTotal(e,t,n){if(n<2)return;const r=e.querySelector("thead tr");if(r){const e=document.createElement("th");e.classList.add("total"),e.style.fontWeight="bold",e.textContent="Total",r.appendChild(e)}t.forEach((e=>{e.querySelectorAll("td");const t=calcularFilaTotal(e,n),r=document.createElement("td");r.classList.add("total"),r.style.fontWeight="bold",r.textContent=t,e.appendChild(r)}))}function calcularColumnaTotal(e,t){let n=!1,r=0;return e.forEach((e=>{const o=e.querySelectorAll("td")[t];if(!o)return;let a=o.textContent.trim();a.startsWith("$")&&(n=!0),r+=moneyToNumber(a)||0})),formatearTotal(r,n)}function calcularFilaTotal(e,t){let n=!1,r=0;return Array.from(e.querySelectorAll("td")).slice(1,t-1).forEach((e=>{let t=e.textContent.trim();t.startsWith("$")&&(n=!0),r+=moneyToNumber(t)||0})),formatearTotal(r,n)}function formatearTotal(e,t){return t?moneyFormat(e):Number.isInteger(e)?e.toFixed(0):e.toFixed(2)}function quitaTotaldeColumna(e,t){if(!e)return;if(e instanceof jQuery&&(e=e[0]),!(e instanceof HTMLTableElement))return;const n=e.querySelector("tbody"),r=n?n.rows:e.rows;if(0===r.length)return;const o=r[r.length-1];(Array.isArray(t)?t:[t]).forEach((e=>{o.cells.length>e&&(o.cells[e].textContent="",o.cells[e].innerHTML="")}))}function quitaTotaldeRenglon(e,t){if(!e)return;if(e instanceof jQuery&&(e=e[0]),!(e instanceof HTMLTableElement))return;const n=e.querySelector("tbody"),r=n?n.rows:e.rows;(Array.isArray(t)?t:[t]).forEach((e=>{if(e>=0&&e<r.length){const t=r[e];if(t.cells.length>0){const e=t.cells.length-1;t.cells[e].textContent="",t.cells[e].innerHTML=""}}}))}function exportToExcel(e,t){try{if(!e||"string"!=typeof e)throw new Error("Invalid file name");if(!t||"string"!=typeof t)throw new Error("Invalid HTML content");const n="data:application/vnd.ms-excel;charset=UTF-8;base64,",r='\n      <html xmlns:o="urn:schemas-microsoft-com:office:office" \n          xmlns:x="urn:schemas-microsoft-com:office:excel" \n          xmlns="http://www.w3.org/TR/REC-html40">\n        <head>\n          <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />\n          <meta charset="utf-8" />\n          \x3c!--[if gte mso 9]>\n          <xml>\n            <x:ExcelWorkbook>\n              <x:ExcelWorksheets>\n                <x:ExcelWorksheet>\n                  <x:Name>{worksheet}</x:Name>\n                  <x:WorksheetOptions>\n                    <x:DisplayGridlines/>\n                  </x:WorksheetOptions>\n                </x:ExcelWorksheet>\n              </x:ExcelWorksheets>\n            </x:ExcelWorkbook>\n          </xml>\n          <![endif]--\x3e\n        </head>\n        <body>\n          <table>{table}</table>\n        </body>\n      </html>',o=e=>window.btoa(unescape(encodeURIComponent(e))),a=(e,t)=>e.replace(/{(\w+)}/g,((e,n)=>t[n]||"")),l=document.createElement("a");return l.download=`${e.trim()}.xls`,l.href=n+o(a(r,{worksheet:"Worksheet",table:t})),document.body.appendChild(l),l.click(),document.body.removeChild(l),!0}catch(e){return showToast("Error al exportar a Excel","error"),!1}}function tablaCompleta(e){try{if(!e||!$(e).length)throw new Error("Invalid table element");const t=$(e).DataTable();if(!t)throw new Error("DataTable not initialized");const n=t.rows().data().toArray(),r=t.columns().header().toArray().map((e=>$(e).text().trim()));let o='<table border="1">';return o+="<thead><tr>",r.slice(0,-1).forEach((e=>{o+=`<th style="background-color: #f2f2f2; padding: 8px;">${escapeHtml(e)}</th>`})),o+="</tr></thead>",o+="<tbody>",n.forEach((e=>{o+="<tr>",Object.values(e).forEach((e=>{o+=`<td style="padding: 6px;">${escapeHtml(String(e))}</td>`})),o+="</tr>"})),o+="</tbody></table>",o}catch(e){return showToast("Error al generar la tabla","error"),""}}function escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function exportaTablaCompletaAExcel(e,t){exportToExcel(e,tablaCompleta(t))}function ponTablaPaginada(e,t={}){let n={pagingType:"numbers",order:[],oLanguage:{sProcessing:"Procesando...",sLengthMenu:"Mostrar _MENU_ registros",sZeroRecords:"No se encontraron registros",sInfo:"Mostrando desde _START_ hasta _END_ de _TOTAL_ registros",sInfoEmpty:"Mostrando desde 0 hasta 0 de 0 registros",sInfoFiltered:"",sInfoPostFix:"",sSearch:"Buscar:",sUrl:"",oPaginate:{sFirst:"Primero",sPrevious:"Anterior",sNext:"Siguiente",sLast:"Último"}}};$.extend(n,t),$(e).DataTable(n)}$(document).ajaxStart((function(){mostrarCargando()})).ajaxStop((function(){ocultarCargando()}));const Toast=Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}}),ToastBottom=Swal.mixin({toast:!0,position:"bottom-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}});function showToast(e="",t="info",n=3e3){Toast.fire({icon:t,title:e,timer:n})}function showToastDown(e="",t="info",n=3e3){ToastBottom.fire({icon:t,title:e,timer:n})}function showModal(e,t="",n="miModal",r=null){try{if("string"!=typeof e&&!(e instanceof jQuery))throw new Error("Invalid HTML content");if("string"!=typeof n||!n.trim())throw new Error("Invalid modal ID");const o=n.trim();if(!$(`#${o}`).length){const e=`\n        <div id="${o}" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="${o}Label">\n          <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">\n            <div class="modal-content">\n              <div class="modal-header">\n                <h5 class="modal-title" id="${o}-modaltitle"></h5>\n                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n              </div>\n              <div class="modal-body">\n                <div id="${o}-modalescondido"></div> \n              </div>\n              <div class="modal-footer"></div>\n            </div>\n          </div>\n        </div>`;$("body").append(e)}const a=$(`#${o}`),l=$(`#${o}-modalescondido`),i=$(`#${o}-modaltitle`);return l.html(e),i.text(t||""),a.off("hidden.bs.modal").on("hidden.bs.modal",(function(){if("function"==typeof r)try{r()}catch(e){}a.off("hidden.bs.modal")})),a.modal("show"),a}catch(e){return showToast("Error al mostrar la ventana modal","error"),null}}function cierraModal(e){const t=$(`#${e}`);if(!t.length)return;const n=()=>{t.hasClass("show")?(t.modal("hide"),t.remove()):setTimeout(n,10)};n()}function convertToTable(e,t={}){if(!e)return"";const n={tableClass:"table",stripHtml:!0,maxCellLength:100,emptyText:"-",...t};try{return Array.isArray(e)?arrayToTable(e,n):objectToTable(e,n)}catch(e){return""}}function objectToTable(e,t){const n=Object.keys(e);return 0===n.length?t.emptyText:`\n    <table class="${escapeHtml(t.tableClass)}">\n      <thead>\n        ${createHeaderRow(n,t)}\n      </thead>\n      <tbody>\n        ${objectToRow(e,n,t)}\n      </tbody>\n    </table>\n  `}function arrayToTable(e,t){if(!e.length)return t.emptyText;const n=Object.keys(e[0]);return 0===n.length?t.emptyText:`\n    <table class="${escapeHtml(t.tableClass)}">\n      <thead>\n        ${createHeaderRow(n,t)}\n      </thead>\n      <tbody>\n        ${e.map((e=>objectToRow(e,n,t))).join("")}\n      </tbody>\n    </table>\n  `}function objectToRow(e,t,n){return`\n    <tr>\n      ${t.map((t=>`<td>${formatCellContent(e[t],n)}</td>`)).join("")}\n    </tr>\n  `}function createHeaderRow(e,t){return`\n    <tr>\n      ${e.map((e=>`<th>${formatCellContent(e,t)}</th>`)).join("")}\n    </tr>\n  `}function formatCellContent(e,t){if(null==e)return t.emptyText;let n=String(e);if(t.maxCellLength&&n.length>t.maxCellLength&&(n=`${n.substring(0,t.maxCellLength)}...`),t.stripHtml){const e=document.createElement("div");e.innerHTML=n,n=e.textContent||e.innerText||""}return escapeHtml(n)}function limitText(e,t){e.value.length>t&&(e.value=e.value.slice(0,t))}function ponValorEnSelect(e,t,n){e.find(`option[value='${t}']`).remove(),e.find("option").prop("selected",!1).removeAttr("selected");let r=$("<option></option>").val(t).text(n).attr("selected","selected");e.append(r).val(t).trigger("change")}function limpia(e){return e.replace("-"," ").replace(/\s+/g," ").trim()}function inArray(e,t){return t.includes(e)}function serializeParams(e,t){let n=[];for(let r in e){if(!e.hasOwnProperty(r))continue;let o=t?`${t}[${r}]`:r,a=e[r];null==a&&(a=""),"object"!=typeof a||Array.isArray(a)?Array.isArray(a)?a.forEach(((e,t)=>{null==e&&(e=""),n.push(serializeParams(e,`${o}[${t}]`))})):n.push(`${encodeURIComponent(o)}=${encodeURIComponent(a)}`):n.push(serializeParams(a,o))}return n.join("&")}async function getValue(e,t={},n){const r={timeout:t.timeout||12e3,retryAttempts:t.retryAttempts||1,retryDelay:t.retryDelay||1e3},o={...t};delete o.timeout,delete o.retryAttempts,delete o.retryDelay;const a=serializeParams(t),l=async()=>{let t=0,n=null;for(;t<r.retryAttempts;)try{const t=fetch(fixUrl(e),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},body:a}),n=await Promise.race([t,new Promise(((e,t)=>setTimeout((()=>t(new Error("Timeout"))),r.timeout)))]),o=await n.text();if(!n.ok)throw{status:n.status,statusText:n.statusText,response:o};return{response:o,error:null}}catch(e){n={error:e.message||"Error desconocido",status:e.status||0},manejaError(e),t++,t<r.retryAttempts&&await new Promise((e=>setTimeout(e,r.retryDelay)))}return{response:null,error:n}};if("function"==typeof n){const e=await l();return void n(e.response,e.error)}const i=await l();if(i.error)throw i.error;return i.response}function manejaError(e){const t={401:"Su sesión ha expirado, por favor inicie sesión nuevamente.",403:"No tiene permiso para realizar esta acción.",404:"No se encontró la página solicitada.",500:"Error interno del servidor."};let n=e&&e.status;showToast(t[n]||"Error desconocido","error"),401===n&&(window.Swal?Swal.fire({icon:"error",title:"Error",text:t[401],timer:2e3,didClose:()=>{window.location.href=fixUrl("admin/login")}}):(alert(t[401]),window.location.href=fixUrl("admin/login")))}async function getObject(e,t,n){const r=async e=>{try{return{result:JSON.parse(e),error:null}}catch(e){return{result:null,error:e}}};if("function"!=typeof n)try{const n=await getValue(e,t),{result:o,error:a}=await r(n);if(a)throw a;return o}catch(e){throw e}try{await getValue(e,t,(async(e,t)=>{if(t)return void n(null,t);const{result:o,error:a}=await r(e);n(o,a)}))}catch(e){n(null,e)}}async function getSession(){return await getObject("admin/sess",{})}function mostrarCargando(){if(!document.querySelector(".loading-container")){let e=document.createElement("div");e.classList.add("loading-container");let t=document.createElement("div");t.classList.add("loading"),e.appendChild(t),e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(255, 255, 255, 0.8)",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="9999",t.style.border="5px solid #f3f3f3",t.style.borderTop="5px solid #3498db",t.style.borderRadius="50%",t.style.width="50px",t.style.height="50px",t.style.animation="spin 2s linear infinite",document.body.appendChild(e)}}function ocultarCargando(){let e=document.querySelector(".loading-container");e&&e.remove()}function moneyToNumber(e){if(null==e||""===e)return 0;const t=String(e).replace(/[^0-9.-]+/g,"");return""===t||"."===t?0:parseFloat(t)}function moneyFormat(e,t="USD"){let n=moneyToNumber(e);return isNaN(n)&&(n=0),new Intl.NumberFormat("en-US",{style:"currency",currency:t}).format(n)}