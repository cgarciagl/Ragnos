if(!base_url||"string"!=typeof base_url)try{const e=new URL(window.location.href),t=e.pathname.replace(/^\/|\/$/g,"").split("/").filter(Boolean);base_url=`${e.protocol}//${e.host}/${encodeURIComponent(t[0]||"")}/`}catch(e){base_url="/"}function fixUrl(e){try{if("string"!=typeof e||!e.trim())return"";if(/^https?:\/\//i.test(e)||"undefined"==typeof base_url)return e;if("string"!=typeof base_url||!base_url.trim())return e;const t=base_url.replace(/\/+$/,"");return`${t}/index.php/${e.replace(/^\/+/,"")}`}catch(e){return""}}function redirectTo(e){setTimeout((function(){window.location.href=fixUrl(e)}),0)}function openInNew(e){window.open(fixUrl(e),"_new")}function redirectByPost(e,t={},r=!0){try{if("string"!=typeof e||!e.trim())return!1;const o=crearFormulario(fixUrl(e),t,r);return document.body.appendChild(o),o.submit(),document.body.removeChild(o),!0}catch(e){return!1}}function crearFormulario(e,t,r){const o=document.createElement("form");return o.method="post",o.action=e,r&&(o.target="_blank"),"undefined"!=typeof csrfToken&&agregarCampoOculto(o,"csrf_token",csrfToken),Object.entries(t).forEach((([e,t])=>{agregarCampoOculto(o,e,String(t))})),o}function agregarCampoOculto(e,t,r){const o=document.createElement("input");o.type="hidden",o.name=t,o.value=r,e.appendChild(o)}function trim(e){return e.trim()}function refreshPage(){location.reload()}function serializeForm(e){return e instanceof HTMLFormElement?Object.fromEntries(new FormData(e)):{}}function shakeElement(e){e.classList.add("shake"),setTimeout((()=>e.classList.remove("shake")),400)}function ponTotalesEnTabla(e,t=!1,r=!0){if(!(e&&(e instanceof HTMLTableElement||e instanceof jQuery)))return;e instanceof jQuery&&(e=e[0]);const o=e.querySelector("tbody"),n=Array.from(o.querySelectorAll("tr"));let a=n[0]?n[0].querySelectorAll("td").length:0;r&&(agregarColumnaTotal(e,n,a),a+=1),t&&agregarRenglonTotal(o,n,a)}function agregarRenglonTotal(e,t,r){if(t.length<1)return;const o=document.createElement("tr");for(let e=0;e<r;e++){const r=document.createElement("td");r.classList.add("total"),r.style.fontWeight="bold",r.textContent=0===e?"Total":calcularColumnaTotal(t,e),o.appendChild(r)}e.appendChild(o)}function agregarColumnaTotal(e,t,r){if(r<2)return;const o=e.querySelector("thead tr");if(o){const e=document.createElement("th");e.classList.add("total"),e.style.fontWeight="bold",e.textContent="Total",o.appendChild(e)}t.forEach((e=>{e.querySelectorAll("td");const t=calcularFilaTotal(e,r),o=document.createElement("td");o.classList.add("total"),o.style.fontWeight="bold",o.textContent=t,e.appendChild(o)}))}function calcularColumnaTotal(e,t){let r=!1,o=0;return e.forEach((e=>{const n=e.querySelectorAll("td")[t];if(!n)return;let a=n.textContent.trim();a.startsWith("$")&&(r=!0),o+=moneyToNumber(a)||0})),formatearTotal(o,r)}function calcularFilaTotal(e,t){let r=!1,o=0;return Array.from(e.querySelectorAll("td")).slice(1,t-1).forEach((e=>{let t=e.textContent.trim();t.startsWith("$")&&(r=!0),o+=moneyToNumber(t)||0})),formatearTotal(o,r)}function formatearTotal(e,t){return t?moneyFormat(e):Number.isInteger(e)?e.toFixed(0):e.toFixed(2)}function exportToExcel(e,t){try{if(!e||"string"!=typeof e)throw new Error("Invalid file name");if(!t||"string"!=typeof t)throw new Error("Invalid HTML content");const r="data:application/vnd.ms-excel;charset=UTF-8;base64,",o='\n      <html xmlns:o="urn:schemas-microsoft-com:office:office" \n          xmlns:x="urn:schemas-microsoft-com:office:excel" \n          xmlns="http://www.w3.org/TR/REC-html40">\n        <head>\n          <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />\n          <meta charset="utf-8" />\n          \x3c!--[if gte mso 9]>\n          <xml>\n            <x:ExcelWorkbook>\n              <x:ExcelWorksheets>\n                <x:ExcelWorksheet>\n                  <x:Name>{worksheet}</x:Name>\n                  <x:WorksheetOptions>\n                    <x:DisplayGridlines/>\n                  </x:WorksheetOptions>\n                </x:ExcelWorksheet>\n              </x:ExcelWorksheets>\n            </x:ExcelWorkbook>\n          </xml>\n          <![endif]--\x3e\n        </head>\n        <body>\n          <table>{table}</table>\n        </body>\n      </html>',n=e=>window.btoa(unescape(encodeURIComponent(e))),a=(e,t)=>e.replace(/{(\w+)}/g,((e,r)=>t[r]||"")),l=document.createElement("a");return l.download=`${e.trim()}.xls`,l.href=r+n(a(o,{worksheet:"Worksheet",table:t})),document.body.appendChild(l),l.click(),document.body.removeChild(l),!0}catch(e){return showToast("Error al exportar a Excel","error"),!1}}function tablaCompleta(e){try{if(!e||!$(e).length)throw new Error("Invalid table element");const t=$(e).DataTable();if(!t)throw new Error("DataTable not initialized");const r=t.rows().data().toArray(),o=t.columns().header().toArray().map((e=>$(e).text().trim()));let n='<table border="1">';return n+="<thead><tr>",o.slice(0,-1).forEach((e=>{n+=`<th style="background-color: #f2f2f2; padding: 8px;">${escapeHtml(e)}</th>`})),n+="</tr></thead>",n+="<tbody>",r.forEach((e=>{n+="<tr>",Object.values(e).forEach((e=>{n+=`<td style="padding: 6px;">${escapeHtml(String(e))}</td>`})),n+="</tr>"})),n+="</tbody></table>",n}catch(e){return showToast("Error al generar la tabla","error"),""}}function escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function exportaTablaCompletaAExcel(e,t){exportToExcel(e,tablaCompleta(t))}function ponTablaPaginada(e,t={}){let r={pagingType:"numbers",order:[],oLanguage:{sProcessing:"Procesando...",sLengthMenu:"Mostrar _MENU_ registros",sZeroRecords:"No se encontraron registros",sInfo:"Mostrando desde _START_ hasta _END_ de _TOTAL_ registros",sInfoEmpty:"Mostrando desde 0 hasta 0 de 0 registros",sInfoFiltered:"",sInfoPostFix:"",sSearch:"Buscar:",sUrl:"",oPaginate:{sFirst:"Primero",sPrevious:"Anterior",sNext:"Siguiente",sLast:"Último"}}};$.extend(r,t),$(e).DataTable(r)}$(document).ajaxStart((function(){mostrarCargando()})).ajaxStop((function(){ocultarCargando()}));const Toast=Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}}),ToastBottom=Swal.mixin({toast:!0,position:"bottom-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}});function showToast(e="",t="info",r=3e3){Toast.fire({icon:t,title:e,timer:r})}function showToastDown(e="",t="info",r=3e3){ToastBottom.fire({icon:t,title:e,timer:r})}function showModal(e,t="",r="miModal",o=null){try{if("string"!=typeof e&&!(e instanceof jQuery))throw new Error("Invalid HTML content");if("string"!=typeof r||!r.trim())throw new Error("Invalid modal ID");const n=r.trim();if(!$(`#${n}`).length){const e=`\n        <div id="${n}" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="${n}Label" aria-hidden="true">\n          <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">\n            <div class="modal-content">\n              <div class="modal-header">\n                <h5 class="modal-title" id="${n}-modaltitle"></h5>\n                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n              </div>\n              <div class="modal-body">\n                <div id="${n}-modalescondido"></div> \n              </div>\n              <div class="modal-footer"></div>\n            </div>\n          </div>\n        </div>`;$("body").append(e)}const a=$(`#${n}`),l=$(`#${n}-modalescondido`),i=$(`#${n}-modaltitle`);return l.html(e),i.text(t||""),a.off("hidden.bs.modal").on("hidden.bs.modal",(function(){if("function"==typeof o)try{o()}catch(e){}a.off("hidden.bs.modal")})),a.modal("show"),a}catch(e){return showToast("Error al mostrar la ventana modal","error"),null}}function cierraModal(e){$("#"+e).modal("hide")}function convertToTable(e,t={}){if(!e)return"";const r={tableClass:"table",stripHtml:!0,maxCellLength:100,emptyText:"-",...t};try{return Array.isArray(e)?arrayToTable(e,r):objectToTable(e,r)}catch(e){return""}}function objectToTable(e,t){const r=Object.keys(e);return 0===r.length?t.emptyText:`\n    <table class="${escapeHtml(t.tableClass)}">\n      <thead>\n        ${createHeaderRow(r,t)}\n      </thead>\n      <tbody>\n        ${objectToRow(e,r,t)}\n      </tbody>\n    </table>\n  `}function arrayToTable(e,t){if(!e.length)return t.emptyText;const r=Object.keys(e[0]);return 0===r.length?t.emptyText:`\n    <table class="${escapeHtml(t.tableClass)}">\n      <thead>\n        ${createHeaderRow(r,t)}\n      </thead>\n      <tbody>\n        ${e.map((e=>objectToRow(e,r,t))).join("")}\n      </tbody>\n    </table>\n  `}function objectToRow(e,t,r){return`\n    <tr>\n      ${t.map((t=>`<td>${formatCellContent(e[t],r)}</td>`)).join("")}\n    </tr>\n  `}function createHeaderRow(e,t){return`\n    <tr>\n      ${e.map((e=>`<th>${formatCellContent(e,t)}</th>`)).join("")}\n    </tr>\n  `}function formatCellContent(e,t){if(null==e)return t.emptyText;let r=String(e);if(t.maxCellLength&&r.length>t.maxCellLength&&(r=`${r.substring(0,t.maxCellLength)}...`),t.stripHtml){const e=document.createElement("div");e.innerHTML=r,r=e.textContent||e.innerText||""}return escapeHtml(r)}function limitText(e,t){e.value.length>t&&(e.value=e.value.slice(0,t))}function ponValorEnSelect(e,t,r){e.find("option[value='"+t+"']").remove(),e.find("option").prop("selected",!1).removeAttr("selected");let o=$("<option></option>").val(t).text(r).attr("selected","selected");e.append(o).val(t).trigger("change")}function limpia(e){return e.replace("-"," ").replace(/\s+/g," ").trim()}function inArray(e,t){return t.includes(e)}function serializeParams(e,t){let r=[];for(let o in e){if(!e.hasOwnProperty(o))continue;let n=t?`${t}[${o}]`:o,a=e[o];null==a&&(a=""),"object"!=typeof a||Array.isArray(a)?Array.isArray(a)?a.forEach(((e,t)=>{null==e&&(e=""),r.push(serializeParams(e,`${n}[${t}]`))})):r.push(encodeURIComponent(n)+"="+encodeURIComponent(a)):r.push(serializeParams(a,n))}return r.join("&")}async function getValue(e,t={},r){const o={timeout:t.timeout||12e3,retryAttempts:t.retryAttempts||1,retryDelay:t.retryDelay||1e3},n={...t};delete n.timeout,delete n.retryAttempts,delete n.retryDelay;const a=serializeParams(t),l=async()=>{let t=0,r=null;for(;t<o.retryAttempts;)try{const t=fetch(fixUrl(e),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},body:a}),r=await Promise.race([t,new Promise(((e,t)=>setTimeout((()=>t(new Error("Timeout"))),o.timeout)))]),n=await r.text();if(!r.ok)throw{status:r.status,statusText:r.statusText,response:n};return{response:n,error:null}}catch(e){r={error:e.message||"Error desconocido",status:e.status||0},manejaError(e),t++,t<o.retryAttempts&&await new Promise((e=>setTimeout(e,o.retryDelay)))}return{response:null,error:r}};if("function"==typeof r){const e=await l();return void r(e.response,e.error)}const i=await l();if(i.error)throw i.error;return i.response}function manejaError(e){const t={401:"Su sesión ha expirado, por favor inicie sesión nuevamente.",403:"No tiene permiso para realizar esta acción.",404:"No se encontró la página solicitada.",500:"Error interno del servidor."};let r=e&&e.status;showToast(t[r]||"Error desconocido","error"),401===r&&(window.Swal?Swal.fire({icon:"error",title:"Error",text:t[401],timer:2e3,didClose:()=>{window.location.href=fixUrl("admin/login")}}):(alert(t[401]),window.location.href=fixUrl("admin/login")))}async function getObject(e,t,r){const o=async e=>{try{return{result:JSON.parse(e),error:null}}catch(e){return{result:null,error:e}}};if("function"!=typeof r)try{const r=await getValue(e,t),{result:n,error:a}=await o(r);if(a)throw a;return n}catch(e){throw e}try{await getValue(e,t,(async(e,t)=>{if(t)return void r(null,t);const{result:n,error:a}=await o(e);r(n,a)}))}catch(e){r(null,e)}}async function getSession(){return await getObject("admin/sess",{})}function mostrarCargando(){if(!document.querySelector(".loading-container")){let e=document.createElement("div");e.classList.add("loading-container");let t=document.createElement("div");t.classList.add("loading"),e.appendChild(t),e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(255, 255, 255, 0.8)",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="9999",t.style.border="5px solid #f3f3f3",t.style.borderTop="5px solid #3498db",t.style.borderRadius="50%",t.style.width="50px",t.style.height="50px",t.style.animation="spin 2s linear infinite",document.body.appendChild(e)}}function ocultarCargando(){let e=document.querySelector(".loading-container");e&&e.remove()}function moneyFormat(e,t="USD"){return e&&e.toString().includes("$")?e:new Intl.NumberFormat("en-US",{style:"currency",currency:t}).format(e)}function moneyToNumber(e){return parseFloat(e.replace(/[^0-9.-]+/g,""))}