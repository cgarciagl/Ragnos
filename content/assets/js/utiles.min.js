if(!base_url||"string"!=typeof base_url)try{const e=new URL(window.location.href),t=e.pathname.replace(/^\/|\/$/g,"").split("/").filter(Boolean);base_url=`${e.protocol}//${e.host}/${encodeURIComponent(t[0]||"")}/`}catch(e){base_url="/"}let debounceTimer;function debounce(e,t){clearTimeout(debounceTimer),debounceTimer=setTimeout((()=>{e()}),t)}function aplicarDebounceABusqueda(e,t=500){$("div.dt-search input").off("input.dt").on("input.dt",(function(){const o=this.value;debounce((()=>{e.search(o).draw()}),t)}))}function fixUrl(e){try{if("string"!=typeof e||!e.trim())return"";if(/^https?:\/\//i.test(e)||"undefined"==typeof base_url)return e;if("string"!=typeof base_url||!base_url.trim())return e;const t=base_url.replace(/\/+$/,"");return`${t}/index.php/${e.replace(/^\/+/,"")}`}catch(e){return""}}function redirectTo(e){setTimeout((function(){window.location.href=fixUrl(e)}),0)}function openInNew(e){window.open(fixUrl(e),"_new")}function redirectByPost(e,t={},o=!0){try{if("string"!=typeof e||!e.trim())return!1;const n=crearFormulario(fixUrl(e),t,o);return document.body.appendChild(n),n.submit(),document.body.removeChild(n),!0}catch(e){return!1}}function crearFormulario(e,t,o){const n=document.createElement("form");return n.method="post",n.action=e,o&&(n.target="_blank"),"undefined"!=typeof csrfToken&&agregarCampoOculto(n,"csrf_token",csrfToken),Object.entries(t).forEach((([e,t])=>{agregarCampoOculto(n,e,String(t))})),n}function agregarCampoOculto(e,t,o){const n=document.createElement("input");n.type="hidden",n.name=t,n.value=o,e.appendChild(n)}function trim(e){return e.trim()}function refreshPage(){location.reload()}function serializeForm(e){return e instanceof HTMLFormElement?Object.fromEntries(new FormData(e)):{}}function shakeElement(e){e instanceof jQuery&&(e=e[0]),e.classList.add("shake"),setTimeout((()=>e.classList.remove("shake")),400)}function ponTotalesEnTabla(e,t=!1,o=!0){if(!(e&&(e instanceof HTMLTableElement||e instanceof jQuery)))return;e instanceof jQuery&&(e=e[0]);const n=e.querySelector("tbody"),r=Array.from(n.querySelectorAll("tr"));let a=r[0]?r[0].querySelectorAll("td").length:0;o&&(agregarColumnaTotal(e,r,a),a+=1),t&&agregarRenglonTotal(n,r,a)}function agregarRenglonTotal(e,t,o){if(t.length<1)return;const n=document.createElement("tr");for(let e=0;e<o;e++){const o=document.createElement("td");o.classList.add("total"),o.style.fontWeight="bold",o.textContent=0===e?"Total":calcularColumnaTotal(t,e),n.appendChild(o)}e.appendChild(n)}function agregarColumnaTotal(e,t,o){if(o<2)return;const n=e.querySelector("thead tr");if(n){const e=document.createElement("th");e.classList.add("total"),e.style.fontWeight="bold",e.textContent="Total",n.appendChild(e)}t.forEach((e=>{e.querySelectorAll("td");const t=calcularFilaTotal(e,o),n=document.createElement("td");n.classList.add("total"),n.style.fontWeight="bold",n.textContent=t,e.appendChild(n)}))}function calcularColumnaTotal(e,t){let o=!1,n=0;return e.forEach((e=>{const r=e.querySelectorAll("td")[t];if(!r)return;let a=r.textContent.trim();a.startsWith("$")&&(o=!0),n+=moneyToNumber(a)||0})),formatearTotal(n,o)}function calcularFilaTotal(e,t){let o=!1,n=0;return Array.from(e.querySelectorAll("td")).slice(1,t-1).forEach((e=>{let t=e.textContent.trim();t.startsWith("$")&&(o=!0),n+=moneyToNumber(t)||0})),formatearTotal(n,o)}function formatearTotal(e,t){return t?moneyFormat(e):Number.isInteger(e)?e.toFixed(0):e.toFixed(2)}function exportToExcel(e,t){try{if(!e||"string"!=typeof e)throw new Error("Invalid file name");if(!t||"string"!=typeof t)throw new Error("Invalid HTML content");const o="data:application/vnd.ms-excel;charset=UTF-8;base64,",n='\n      <html xmlns:o="urn:schemas-microsoft-com:office:office" \n          xmlns:x="urn:schemas-microsoft-com:office:excel" \n          xmlns="http://www.w3.org/TR/REC-html40">\n        <head>\n          <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />\n          <meta charset="utf-8" />\n          \x3c!--[if gte mso 9]>\n          <xml>\n            <x:ExcelWorkbook>\n              <x:ExcelWorksheets>\n                <x:ExcelWorksheet>\n                  <x:Name>{worksheet}</x:Name>\n                  <x:WorksheetOptions>\n                    <x:DisplayGridlines/>\n                  </x:WorksheetOptions>\n                </x:ExcelWorksheet>\n              </x:ExcelWorksheets>\n            </x:ExcelWorkbook>\n          </xml>\n          <![endif]--\x3e\n        </head>\n        <body>\n          <table>{table}</table>\n        </body>\n      </html>',r=e=>window.btoa(unescape(encodeURIComponent(e))),a=(e,t)=>e.replace(/{(\w+)}/g,((e,o)=>t[o]||"")),l=document.createElement("a");return l.download=`${e.trim()}.xls`,l.href=o+r(a(n,{worksheet:"Worksheet",table:t})),document.body.appendChild(l),l.click(),document.body.removeChild(l),!0}catch(e){return showToast("Error al exportar a Excel","error"),!1}}function tablaCompleta(e){try{if(!e||!$(e).length)throw new Error("Invalid table element");const t=$(e).DataTable();if(!t)throw new Error("DataTable not initialized");const o=t.rows().data().toArray(),n=t.columns().header().toArray().map((e=>$(e).text().trim()));let r='<table border="1">';return r+="<thead><tr>",n.slice(0,-1).forEach((e=>{r+=`<th style="background-color: #f2f2f2; padding: 8px;">${escapeHtml(e)}</th>`})),r+="</tr></thead>",r+="<tbody>",o.forEach((e=>{r+="<tr>",Object.values(e).forEach((e=>{r+=`<td style="padding: 6px;">${escapeHtml(String(e))}</td>`})),r+="</tr>"})),r+="</tbody></table>",r}catch(e){return showToast("Error al generar la tabla","error"),""}}function escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function exportaTablaCompletaAExcel(e,t){exportToExcel(e,tablaCompleta(t))}function ponTablaPaginada(e,t={}){let o={pagingType:"numbers",order:[],oLanguage:{sProcessing:"Procesando...",sLengthMenu:"Mostrar _MENU_ registros",sZeroRecords:"No se encontraron registros",sInfo:"Mostrando desde _START_ hasta _END_ de _TOTAL_ registros",sInfoEmpty:"Mostrando desde 0 hasta 0 de 0 registros",sInfoFiltered:"",sInfoPostFix:"",sSearch:"Buscar:",sUrl:"",oPaginate:{sFirst:"Primero",sPrevious:"Anterior",sNext:"Siguiente",sLast:"Último"}}};$.extend(o,t),$(e).DataTable(o)}$(document).ajaxStart((function(){mostrarCargando()})).ajaxStop((function(){ocultarCargando()}));const Toast=Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}}),ToastBottom=Swal.mixin({toast:!0,position:"bottom-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}});function showToast(e="",t="info",o=3e3){Toast.fire({icon:t,title:e,timer:o})}function showToastDown(e="",t="info",o=3e3){ToastBottom.fire({icon:t,title:e,timer:o})}function showModal(e,t="",o="miModal",n=null){try{if("string"!=typeof e&&!(e instanceof jQuery))throw new Error("Invalid HTML content");if("string"!=typeof o||!o.trim())throw new Error("Invalid modal ID");const r=o.trim();if(!$(`#${r}`).length){const e=`\n        <div id="${r}" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="${r}Label">\n          <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">\n            <div class="modal-content">\n              <div class="modal-header">\n                <h5 class="modal-title" id="${r}-modaltitle"></h5>\n                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n              </div>\n              <div class="modal-body">\n                <div id="${r}-modalescondido"></div> \n              </div>\n              <div class="modal-footer"></div>\n            </div>\n          </div>\n        </div>`;$("body").append(e)}const a=$(`#${r}`),l=$(`#${r}-modalescondido`),i=$(`#${r}-modaltitle`);return l.html(e),i.text(t||""),a.off("hidden.bs.modal").on("hidden.bs.modal",(function(){if("function"==typeof n)try{n()}catch(e){}a.off("hidden.bs.modal")})),a.modal("show"),a}catch(e){return showToast("Error al mostrar la ventana modal","error"),null}}function cierraModal(e){const t=$(`#${e}`);if(!t.length)return;const o=()=>{t.hasClass("show")?(t.modal("hide"),t.remove()):setTimeout(o,10)};o()}function convertToTable(e,t={}){if(!e)return"";const o={tableClass:"table",stripHtml:!0,maxCellLength:100,emptyText:"-",...t};try{return Array.isArray(e)?arrayToTable(e,o):objectToTable(e,o)}catch(e){return""}}function objectToTable(e,t){const o=Object.keys(e);return 0===o.length?t.emptyText:`\n    <table class="${escapeHtml(t.tableClass)}">\n      <thead>\n        ${createHeaderRow(o,t)}\n      </thead>\n      <tbody>\n        ${objectToRow(e,o,t)}\n      </tbody>\n    </table>\n  `}function arrayToTable(e,t){if(!e.length)return t.emptyText;const o=Object.keys(e[0]);return 0===o.length?t.emptyText:`\n    <table class="${escapeHtml(t.tableClass)}">\n      <thead>\n        ${createHeaderRow(o,t)}\n      </thead>\n      <tbody>\n        ${e.map((e=>objectToRow(e,o,t))).join("")}\n      </tbody>\n    </table>\n  `}function objectToRow(e,t,o){return`\n    <tr>\n      ${t.map((t=>`<td>${formatCellContent(e[t],o)}</td>`)).join("")}\n    </tr>\n  `}function createHeaderRow(e,t){return`\n    <tr>\n      ${e.map((e=>`<th>${formatCellContent(e,t)}</th>`)).join("")}\n    </tr>\n  `}function formatCellContent(e,t){if(null==e)return t.emptyText;let o=String(e);if(t.maxCellLength&&o.length>t.maxCellLength&&(o=`${o.substring(0,t.maxCellLength)}...`),t.stripHtml){const e=document.createElement("div");e.innerHTML=o,o=e.textContent||e.innerText||""}return escapeHtml(o)}function limitText(e,t){e.value.length>t&&(e.value=e.value.slice(0,t))}function ponValorEnSelect(e,t,o){e.find(`option[value='${t}']`).remove(),e.find("option").prop("selected",!1).removeAttr("selected");let n=$("<option></option>").val(t).text(o).attr("selected","selected");e.append(n).val(t).trigger("change")}function limpia(e){return e.replace("-"," ").replace(/\s+/g," ").trim()}function inArray(e,t){return t.includes(e)}function serializeParams(e,t){let o=[];for(let n in e){if(!e.hasOwnProperty(n))continue;let r=t?`${t}[${n}]`:n,a=e[n];null==a&&(a=""),"object"!=typeof a||Array.isArray(a)?Array.isArray(a)?a.forEach(((e,t)=>{null==e&&(e=""),o.push(serializeParams(e,`${r}[${t}]`))})):o.push(`${encodeURIComponent(r)}=${encodeURIComponent(a)}`):o.push(serializeParams(a,r))}return o.join("&")}async function getValue(e,t={},o){const n={timeout:t.timeout||12e3,retryAttempts:t.retryAttempts||1,retryDelay:t.retryDelay||1e3},r={...t};delete r.timeout,delete r.retryAttempts,delete r.retryDelay;const a=serializeParams(t),l=async()=>{let t=0,o=null;for(;t<n.retryAttempts;)try{const t=fetch(fixUrl(e),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},body:a}),o=await Promise.race([t,new Promise(((e,t)=>setTimeout((()=>t(new Error("Timeout"))),n.timeout)))]),r=await o.text();if(!o.ok)throw{status:o.status,statusText:o.statusText,response:r};return{response:r,error:null}}catch(e){o={error:e.message||"Error desconocido",status:e.status||0},manejaError(e),t++,t<n.retryAttempts&&await new Promise((e=>setTimeout(e,n.retryDelay)))}return{response:null,error:o}};if("function"==typeof o){const e=await l();return void o(e.response,e.error)}const i=await l();if(i.error)throw i.error;return i.response}function manejaError(e){const t={401:"Su sesión ha expirado, por favor inicie sesión nuevamente.",403:"No tiene permiso para realizar esta acción.",404:"No se encontró la página solicitada.",500:"Error interno del servidor."};let o=e&&e.status;showToast(t[o]||"Error desconocido","error"),401===o&&(window.Swal?Swal.fire({icon:"error",title:"Error",text:t[401],timer:2e3,didClose:()=>{window.location.href=fixUrl("admin/login")}}):(alert(t[401]),window.location.href=fixUrl("admin/login")))}async function getObject(e,t,o){const n=async e=>{try{return{result:JSON.parse(e),error:null}}catch(e){return{result:null,error:e}}};if("function"!=typeof o)try{const o=await getValue(e,t),{result:r,error:a}=await n(o);if(a)throw a;return r}catch(e){throw e}try{await getValue(e,t,(async(e,t)=>{if(t)return void o(null,t);const{result:r,error:a}=await n(e);o(r,a)}))}catch(e){o(null,e)}}async function getSession(){return await getObject("admin/sess",{})}function mostrarCargando(){if(!document.querySelector(".loading-container")){let e=document.createElement("div");e.classList.add("loading-container");let t=document.createElement("div");t.classList.add("loading"),e.appendChild(t),e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(255, 255, 255, 0.8)",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="9999",t.style.border="5px solid #f3f3f3",t.style.borderTop="5px solid #3498db",t.style.borderRadius="50%",t.style.width="50px",t.style.height="50px",t.style.animation="spin 2s linear infinite",document.body.appendChild(e)}}function ocultarCargando(){let e=document.querySelector(".loading-container");e&&e.remove()}function moneyToNumber(e){if(null==e||""===e)return 0;const t=String(e).replace(/[^0-9.-]+/g,"");return""===t||"."===t?0:parseFloat(t)}function moneyFormat(e,t="USD"){let o=moneyToNumber(e);return isNaN(o)&&(o=0),new Intl.NumberFormat("en-US",{style:"currency",currency:t}).format(o)}