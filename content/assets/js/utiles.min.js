if(!base_url||"string"!=typeof base_url)try{const e=new URL(window.location.href),t=e.pathname.replace(/^\/|\/$/g,"").split("/").filter(Boolean);base_url=`${e.protocol}//${e.host}/${encodeURIComponent(t[0]||"")}/`}catch(e){base_url="/"}let debounceTimer;function debounce(e,t){clearTimeout(debounceTimer),debounceTimer=setTimeout((()=>{e()}),t)}function aplicarDebounceABusqueda(e,t=500){$("div.dt-search input").off("input.dt").on("input.dt",(function(){const r=this.value;debounce((()=>{e.search(r).draw()}),t)}))}function fixUrl(e){try{if("string"!=typeof e||!e.trim())return"";if(/^https?:\/\//i.test(e)||"undefined"==typeof base_url)return e;if("string"!=typeof base_url||!base_url.trim())return e;const t=base_url.replace(/\/+$/,"");return`${t}/index.php/${e.replace(/^\/+/,"")}`}catch(e){return""}}function redirectTo(e){setTimeout((function(){window.location.href=fixUrl(e)}),0)}function openInNew(e){window.open(fixUrl(e),"_new")}function redirectByPost(e,t={},r=!0){try{if("string"!=typeof e||!e.trim())return!1;const n=crearFormulario(fixUrl(e),t,r);return document.body.appendChild(n),n.submit(),document.body.removeChild(n),!0}catch(e){return!1}}function crearFormulario(e,t,r){const n=document.createElement("form");return n.method="post",n.action=e,r&&(n.target="_blank"),"undefined"!=typeof csrfToken&&agregarCampoOculto(n,"csrf_token",csrfToken),Object.entries(t).forEach((([e,t])=>{agregarCampoOculto(n,e,String(t))})),n}function agregarCampoOculto(e,t,r){const n=document.createElement("input");n.type="hidden",n.name=t,n.value=r,e.appendChild(n)}function trim(e){return e.trim()}function refreshPage(){location.reload()}function serializeForm(e){return e instanceof HTMLFormElement?Object.fromEntries(new FormData(e)):{}}function shakeElement(e){e instanceof jQuery&&(e=e[0]),e.classList.add("shake"),setTimeout((()=>e.classList.remove("shake")),400)}function ponTotalesEnTabla(e,t=!0,r=!1){if(!(e&&(e instanceof HTMLTableElement||e instanceof jQuery)))return;e instanceof jQuery&&(e=e[0]);const n=e.querySelector("tbody"),o=Array.from(n.querySelectorAll("tr"));let a=o[0]?o[0].querySelectorAll("td").length:0;r&&(agregarColumnaTotal(e,o,a),a+=1),t&&agregarRenglonTotal(n,o,a)}function agregarRenglonTotal(e,t,r){if(t.length<1)return;const n=document.createElement("tr");for(let e=0;e<r;e++){const r=document.createElement("td");r.classList.add("total"),r.style.fontWeight="bold",r.textContent=0===e?"Total":calcularColumnaTotal(t,e),n.appendChild(r)}e.appendChild(n)}function agregarColumnaTotal(e,t,r){if(r<2)return;const n=e.querySelector("thead tr");if(n){const e=document.createElement("th");e.classList.add("total"),e.style.fontWeight="bold",e.textContent="Total",n.appendChild(e)}t.forEach((e=>{e.querySelectorAll("td");const t=calcularFilaTotal(e,r),n=document.createElement("td");n.classList.add("total"),n.style.fontWeight="bold",n.textContent=t,e.appendChild(n)}))}function calcularColumnaTotal(e,t){let r=!1,n=0;return e.forEach((e=>{const o=e.querySelectorAll("td")[t];if(!o)return;let a=o.textContent.trim();a.startsWith("$")&&(r=!0),n+=moneyToNumber(a)||0})),formatearTotal(n,r)}function calcularFilaTotal(e,t){let r=!1,n=0;return Array.from(e.querySelectorAll("td")).slice(1,t-1).forEach((e=>{let t=e.textContent.trim();t.startsWith("$")&&(r=!0),n+=moneyToNumber(t)||0})),formatearTotal(n,r)}function formatearTotal(e,t){return t?moneyFormat(e):Number.isInteger(e)?e.toFixed(0):e.toFixed(2)}function quitaTotaldeColumna(e,t){if(!e)return;if(e instanceof jQuery&&(e=e[0]),!(e instanceof HTMLTableElement))return;const r=e.querySelector("tbody"),n=r?r.rows:e.rows;if(0===n.length)return;const o=n[n.length-1];(Array.isArray(t)?t:[t]).forEach((e=>{o.cells.length>e&&(o.cells[e].textContent="",o.cells[e].innerHTML="")}))}function quitaTotaldeRenglon(e,t){if(!e)return;if(e instanceof jQuery&&(e=e[0]),!(e instanceof HTMLTableElement))return;const r=e.querySelector("tbody"),n=r?r.rows:e.rows;(Array.isArray(t)?t:[t]).forEach((e=>{if(e>=0&&e<n.length){const t=n[e];if(t.cells.length>0){const e=t.cells.length-1;t.cells[e].textContent="",t.cells[e].innerHTML=""}}}))}function exportToExcel(e,t){try{if(!e||"string"!=typeof e)throw new Error("Invalid file name");if(!t||"string"!=typeof t)throw new Error("Invalid HTML content");const r="data:application/vnd.ms-excel;charset=UTF-8;base64,",n='\n      <html xmlns:o="urn:schemas-microsoft-com:office:office" \n          xmlns:x="urn:schemas-microsoft-com:office:excel" \n          xmlns="http://www.w3.org/TR/REC-html40">\n        <head>\n          <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />\n          <meta charset="utf-8" />\n          \x3c!--[if gte mso 9]>\n          <xml>\n            <x:ExcelWorkbook>\n              <x:ExcelWorksheets>\n                <x:ExcelWorksheet>\n                  <x:Name>{worksheet}</x:Name>\n                  <x:WorksheetOptions>\n                    <x:DisplayGridlines/>\n                  </x:WorksheetOptions>\n                </x:ExcelWorksheet>\n              </x:ExcelWorksheets>\n            </x:ExcelWorkbook>\n          </xml>\n          <![endif]--\x3e\n        </head>\n        <body>\n          <table>{table}</table>\n        </body>\n      </html>',o=e=>window.btoa(unescape(encodeURIComponent(e))),a=(e,t)=>e.replace(/{(\w+)}/g,((e,r)=>t[r]||"")),l=document.createElement("a");return l.download=`${e.trim()}.xls`,l.href=r+o(a(n,{worksheet:"Worksheet",table:t})),document.body.appendChild(l),l.click(),document.body.removeChild(l),!0}catch(e){return showToast("Error al exportar a Excel","error"),!1}}function tablaCompleta(e){try{if(!e||!$(e).length)throw new Error("Invalid table element");const t=$(e).DataTable();if(!t)throw new Error("DataTable not initialized");const r=t.rows().data().toArray(),n=t.columns().header().toArray().map((e=>$(e).text().trim()));let o='<table border="1">';return o+="<thead><tr>",n.slice(0,-1).forEach((e=>{o+=`<th style="background-color: #f2f2f2; padding: 8px;">${escapeHtml(e)}</th>`})),o+="</tr></thead>",o+="<tbody>",r.forEach((e=>{o+="<tr>",Object.values(e).forEach((e=>{o+=`<td style="padding: 6px;">${escapeHtml(String(e))}</td>`})),o+="</tr>"})),o+="</tbody></table>",o}catch(e){return showToast("Error al generar la tabla","error"),""}}function escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function exportaTablaCompletaAExcel(e,t){exportToExcel(e,tablaCompleta(t))}function ponTablaPaginada(e,t={}){let r={pagingType:"numbers",order:[],oLanguage:{sProcessing:"Procesando...",sLengthMenu:"Mostrar _MENU_ registros",sZeroRecords:"No se encontraron registros",sInfo:"Mostrando desde _START_ hasta _END_ de _TOTAL_ registros",sInfoEmpty:"Mostrando desde 0 hasta 0 de 0 registros",sInfoFiltered:"",sInfoPostFix:"",sSearch:"Buscar:",sUrl:"",oPaginate:{sFirst:"Primero",sPrevious:"Anterior",sNext:"Siguiente",sLast:"Último"}}};$.extend(r,t),$(e).DataTable(r)}$(document).ajaxStart((function(){mostrarCargando()})).ajaxStop((function(){ocultarCargando()}));const Toast=Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}}),ToastBottom=Swal.mixin({toast:!0,position:"bottom-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}});function showToast(e="",t="info",r=3e3){Toast.fire({icon:t,title:e,timer:r})}function showToastDown(e="",t="info",r=3e3){ToastBottom.fire({icon:t,title:e,timer:r})}function showModal(e,t="",r="miModal",n=null){try{if("string"!=typeof e&&!(e instanceof jQuery))throw new Error("Invalid HTML content");if("string"!=typeof r||!r.trim())throw new Error("Invalid modal ID");const o=r.trim();if(!$(`#${o}`).length){const e=`\n        <div id="${o}" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="${o}Label">\n          <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">\n            <div class="modal-content">\n              <div class="modal-header">\n                <h5 class="modal-title" id="${o}-modaltitle"></h5>\n                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n              </div>\n              <div class="modal-body">\n                <div id="${o}-modalescondido"></div> \n              </div>\n              <div class="modal-footer"></div>\n            </div>\n          </div>\n        </div>`;$("body").append(e)}const a=$(`#${o}`),l=$(`#${o}-modalescondido`),s=$(`#${o}-modaltitle`);return l.html(e),s.text(t||""),a.off("hidden.bs.modal").on("hidden.bs.modal",(function(){if("function"==typeof n)try{n()}catch(e){}a.off("hidden.bs.modal")})),a.modal("show"),a}catch(e){return showToast("Error al mostrar la ventana modal","error"),null}}function cierraModal(e){const t=$(`#${e}`);if(!t.length)return;const r=()=>{t.hasClass("show")?(t.modal("hide"),t.remove()):setTimeout(r,10)};r()}function convertToTable(e,t={}){if(!e)return"";const r={tableClass:"table",stripHtml:!0,maxCellLength:100,emptyText:"-",...t};try{return Array.isArray(e)?arrayToTable(e,r):objectToTable(e,r)}catch(e){return""}}function objectToTable(e,t){const r=Object.keys(e);return 0===r.length?t.emptyText:`\n    <table class="${escapeHtml(t.tableClass)}">\n      <thead>\n        ${createHeaderRow(r,t)}\n      </thead>\n      <tbody>\n        ${objectToRow(e,r,t)}\n      </tbody>\n    </table>\n  `}function arrayToTable(e,t){if(!e.length)return t.emptyText;const r=Object.keys(e[0]);return 0===r.length?t.emptyText:`\n    <table class="${escapeHtml(t.tableClass)}">\n      <thead>\n        ${createHeaderRow(r,t)}\n      </thead>\n      <tbody>\n        ${e.map((e=>objectToRow(e,r,t))).join("")}\n      </tbody>\n    </table>\n  `}function objectToRow(e,t,r){return`\n    <tr>\n      ${t.map((t=>`<td>${formatCellContent(e[t],r)}</td>`)).join("")}\n    </tr>\n  `}function createHeaderRow(e,t){return`\n    <tr>\n      ${e.map((e=>`<th>${formatCellContent(e,t)}</th>`)).join("")}\n    </tr>\n  `}function formatCellContent(e,t){if(null==e)return t.emptyText;let r=String(e);if(t.maxCellLength&&r.length>t.maxCellLength&&(r=`${r.substring(0,t.maxCellLength)}...`),t.stripHtml){const e=document.createElement("div");e.innerHTML=r,r=e.textContent||e.innerText||""}return escapeHtml(r)}function limitText(e,t){e.value.length>t&&(e.value=e.value.slice(0,t))}function ponValorEnSelect(e,t,r){e.find(`option[value='${t}']`).remove(),e.find("option").prop("selected",!1).removeAttr("selected");let n=$("<option></option>").val(t).text(r).attr("selected","selected");e.append(n).val(t).trigger("change")}function limpia(e){return e.replace("-"," ").replace(/\s+/g," ").trim()}function inArray(e,t){return t.includes(e)}function serializeParams(e,t){let r=[];for(let n in e){if(!e.hasOwnProperty(n))continue;let o=t?`${t}[${n}]`:n,a=e[n];null==a&&(a=""),"object"!=typeof a||Array.isArray(a)?Array.isArray(a)?a.forEach(((e,t)=>{null==e&&(e=""),r.push(serializeParams(e,`${o}[${t}]`))})):r.push(`${encodeURIComponent(o)}=${encodeURIComponent(a)}`):r.push(serializeParams(a,o))}return r.join("&")}async function getValue(e,t={},r){const n={timeout:t.timeout||12e3,retryAttempts:t.retryAttempts||1,retryDelay:t.retryDelay||1e3},o={...t};delete o.timeout,delete o.retryAttempts,delete o.retryDelay;const a=serializeParams(t),l=async()=>{let t=0,r=null;for(;t<n.retryAttempts;)try{const t=fetch(fixUrl(e),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},body:a}),r=await Promise.race([t,new Promise(((e,t)=>setTimeout((()=>t(new Error("Timeout"))),n.timeout)))]),o=await r.text();if(!r.ok)throw{status:r.status,statusText:r.statusText,response:o};return{response:o,error:null}}catch(e){r={error:e.message||"Error desconocido",status:e.status||0},manejaError(e),t++,t<n.retryAttempts&&await new Promise((e=>setTimeout(e,n.retryDelay)))}return{response:null,error:r}};if("function"==typeof r){const e=await l();return void r(e.response,e.error)}const s=await l();if(s.error)throw s.error;return s.response}function manejaError(e){const t={401:"Su sesión ha expirado, por favor inicie sesión nuevamente.",403:"No tiene permiso para realizar esta acción.",404:"No se encontró la página solicitada.",500:"Error interno del servidor."};let r=e&&e.status;showToast(t[r]||"Error desconocido","error"),401===r&&(window.Swal?Swal.fire({icon:"error",title:"Error",text:t[401],timer:2e3,didClose:()=>{window.location.href=fixUrl("admin/login")}}):(alert(t[401]),window.location.href=fixUrl("admin/login")))}async function getObject(e,t,r){const n=async e=>{try{return{result:JSON.parse(e),error:null}}catch(e){return{result:null,error:e}}};if("function"!=typeof r)try{const r=await getValue(e,t),{result:o,error:a}=await n(r);if(a)throw a;return o}catch(e){throw e}try{await getValue(e,t,(async(e,t)=>{if(t)return void r(null,t);const{result:o,error:a}=await n(e);r(o,a)}))}catch(e){r(null,e)}}async function getSession(){return await getObject("admin/sess",{})}function mostrarCargando(){if(!document.querySelector(".loading-container")){let e=document.createElement("div");e.classList.add("loading-container");let t=document.createElement("div");t.classList.add("loading"),e.appendChild(t),e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(255, 255, 255, 0.8)",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="9999",t.style.border="5px solid #f3f3f3",t.style.borderTop="5px solid #3498db",t.style.borderRadius="50%",t.style.width="50px",t.style.height="50px",t.style.animation="spin 2s linear infinite",document.body.appendChild(e)}}function ocultarCargando(){let e=document.querySelector(".loading-container");e&&e.remove()}function moneyToNumber(e){if(null==e||""===e)return 0;const t=String(e).replace(/[^0-9.-]+/g,"");return""===t||"."===t?0:parseFloat(t)}function moneyFormat(e,t="USD"){let r=moneyToNumber(e);return isNaN(r)&&(r=0),new Intl.NumberFormat("en-US",{style:"currency",currency:t}).format(r)}async function postFormData(e,t,r){const n=1,o=1e3,a=async()=>{let r=0,a=null;for(;r<n;)try{const r=fetch(fixUrl(e),{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:t}),n=await r,o=await n.text();if(!n.ok)throw{status:n.status,statusText:n.statusText,response:o};return{response:o,error:null}}catch(e){a={error:e.message||"Error desconocido",status:e.status||0},manejaError(a),r++,r<n&&await new Promise((e=>setTimeout(e,o)))}return{response:null,error:a}};if("function"==typeof r){const e=await a();return void r(e.response,e.error)}const l=await a();if(l.error)throw l.error;return l.response}async function uploadObject(e,t,r){const n=async e=>{try{return{result:JSON.parse(e),error:null}}catch(e){return{result:null,error:e}}};if("function"!=typeof r)try{const r=await postFormData(e,t),{result:o,error:a}=await n(r);if(a)throw a;return o}catch(e){throw e}try{await postFormData(e,t,(async(e,t)=>{if(t)return void r(null,t);const{result:o,error:a}=await n(e);r(o,a)}))}catch(e){r(null,e)}}