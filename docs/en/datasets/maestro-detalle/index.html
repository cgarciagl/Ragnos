<!DOCTYPE html>

<html data-bs-theme="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://cgarciagl.github.io/Ragnos/docs/en/datasets/maestro-detalle/" rel="canonical"/>
<link href="../../../img/favicon.ico" rel="shortcut icon"/>
<title>Maestro-Detalle - Ragnos Docs</title>
<link href="../../../css/bootstrap.min.css" rel="stylesheet"/>
<link href="../../../css/fontawesome.min.css" rel="stylesheet"/>
<link href="../../../css/brands.min.css" rel="stylesheet"/>
<link href="../../../css/solid.min.css" rel="stylesheet"/>
<link href="../../../css/v4-font-face.min.css" rel="stylesheet"/>
<link href="../../../css/base.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/panda-syntax-dark.min.css" id="hljs-light" rel="stylesheet"/>
<link disabled="" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" id="hljs-dark" rel="stylesheet"/>
<link href="../../../css/ragnos_style.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
</head>
<body>
<div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
<div class="container">
<a class="navbar-brand" href="../../">Ragnos Docs</a>
<!-- Expander button -->
<button aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-bs-target="#navbar-collapse" data-bs-toggle="collapse" type="button">
<span class="navbar-toggler-icon"></span>
</button>
<!-- Expanded navigation -->
<div class="navbar-collapse collapse" id="navbar-collapse">
<!-- Main navigation -->
<ul class="nav navbar-nav">
<li class="nav-item">
<a class="nav-link" href="../../">Inicio</a>
</li>
<li class="nav-item dropdown">
<a aria-expanded="false" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button">Fundamentos</a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../../fundamentos/instalacion/">Instalaci칩n</a>
</li>
<li>
<a class="dropdown-item" href="../../fundamentos/primeros_pasos/">Primeros Pasos</a>
</li>
<li>
<a class="dropdown-item" href="../../fundamentos/configuracion/">Configuraci칩n</a>
</li>
<li>
<a class="dropdown-item" href="../../fundamentos/plantilla/">Generador CLI</a>
</li>
</ul>
</li>
<li class="nav-item dropdown">
<a aria-current="page" aria-expanded="false" class="nav-link dropdown-toggle active" data-bs-toggle="dropdown" href="#" role="button">Datasets y Modelos</a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../datasets/">Creando Datasets</a>
</li>
<li>
<a class="dropdown-item" href="../campos/">Referencia de Campos</a>
</li>
<li>
<a class="dropdown-item" href="../guia_RQueryController/">Consultas Avanzadas (RQuery)</a>
</li>
<li>
<a aria-current="page" class="dropdown-item active" href="./">Maestro-Detalle</a>
</li>
</ul>
</li>
<li class="nav-item dropdown">
<a aria-expanded="false" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button">Backend Avanzado</a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../../avanzado/guia_modo_api/">Modo API</a>
</li>
<li>
<a class="dropdown-item" href="../../avanzado/helpers/">Helpers y Utilidades</a>
</li>
<li>
<a class="dropdown-item" href="../../avanzado/hooks/">Hooks y eventos</a>
</li>
<li>
<a class="dropdown-item" href="../../avanzado/autenticacion_integrada/">Autenticaci칩n</a>
</li>
<li>
<a class="dropdown-item" href="../../avanzado/auditlog/">Audit Log</a>
</li>
<li>
<a class="dropdown-item" href="../../avanzado/server_side_events/">Server Side Events</a>
</li>
<li>
<a class="dropdown-item" href="../../avanzado/despliegue/">Despliegue</a>
</li>
</ul>
</li>
<li class="nav-item dropdown">
<a aria-expanded="false" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button">Frontend y Reportes</a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../../frontend/personalizacion_ui/">Personalizaci칩n UI</a>
</li>
<li>
<a class="dropdown-item" href="../../frontend/reportes_simples/">Reportes Simples</a>
</li>
<li>
<a class="dropdown-item" href="../../frontend/funciones_javascript/">Funciones JavaScript</a>
</li>
</ul>
</li>
<li class="nav-item">
<a class="nav-link" href="https://cgarciagl.github.io/Ragnos/">游 Home</a>
</li>
</ul>
<ul class="nav navbar-nav ms-md-auto">
<li class="nav-item">
<a class="nav-link" data-bs-target="#mkdocs_search_modal" data-bs-toggle="modal" href="#">
<i class="fa fa-search"></i> Search
                            </a>
</li>
<li class="nav-item">
<a class="nav-link" href="../guia_RQueryController/" rel="prev">
<i class="fa fa-arrow-left"></i> Previous
                                </a>
</li>
<li class="nav-item">
<a class="nav-link" href="../../avanzado/guia_modo_api/" rel="next">
                                    Next <i class="fa fa-arrow-right"></i>
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="https://github.com/cgarciagl/ragnos"><i class="fa-brands fa-github"></i> GitHub</a>
</li>
</ul>
</div>
</div>
</div>
<div class="container">
<div class="row">
<div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
<div class="navbar-header">
<button class="navbar-toggler collapsed" data-bs-target="#toc-collapse" data-bs-toggle="collapse" title="Table of Contents" type="button">
<span class="fa fa-angle-down"></span>
</button>
</div>
<div class="navbar-collapse collapse card bg-body-tertiary" id="toc-collapse">
<ul class="nav flex-column">
<li class="nav-item" data-bs-level="1"><a class="nav-link" href="#relacion-maestro-detalle-en-ragnos">游늼 Relaci칩n Maestro-Detalle en Ragnos</a>
<ul class="nav flex-column">
<li class="nav-item" data-bs-level="2"><a class="nav-link" href="#arquitectura-de-la-relacion">Arquitectura de la Relaci칩n</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-bs-level="2"><a class="nav-link" href="#1-configurando-el-maestro-controlador-ordenes">1. Configurando el Maestro (Controlador Ordenes)</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-bs-level="2"><a class="nav-link" href="#2-configurando-el-detalle-controlador-ordenesdetalles">2. Configurando el Detalle (Controlador Ordenesdetalles)</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-bs-level="2"><a class="nav-link" href="#hooks-de-javascript-personalizados-opcional">Hooks de javascript personalizados (Opcional)</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-bs-level="2"><a class="nav-link" href="#resumen-del-flujo-de-trabajo">Resumen del flujo de trabajo</a>
<ul class="nav flex-column">
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div></div>
<div class="col-md-9" role="main">
<h1 id="relacion-maestro-detalle-en-ragnos">游늼 Relaci칩n Maestro-Detalle en Ragnos</h1>
<p>Esta gu칤a explica c칩mo crear una pantalla donde tienes un registro principal (como una <strong>Orden de compra</strong>) y una lista de elementos relacionados (los <strong>Detalles</strong> o productos de esa orden).</p>
<h2 id="arquitectura-de-la-relacion">Arquitectura de la Relaci칩n</h2>
<div class="mermaid">graph TD
    User["Usuario"] --&gt;|Abre Pantalla| Master["Controlador Maestro<br/>(Ordenes)"]
    Master --&gt;|Renderiza| View["Vista Principal"]
    View --&gt;|Contiene| Form["Formulario Maestro"]

    subgraph Vinculacion ["L칩gica de Vinculaci칩n"]
        direction TB
        Form --&gt;|"ID Orden"| Logic{"쮼xiste Orden?"}
        Logic -- NO --&gt; Info("Solo muestra Formulario")
        Logic -- "SI (ID=100)" --&gt; LoadDetails["Carga Controlador Detalle"]
    end

    LoadDetails --&gt;|"Inyecta ID=100 como $this-&gt;master"| Detail["Controlador Detalle<br/>(OrdenesDetalles)"]

    subgraph Detalle ["Zona del Detalle"]
        direction TB
        Detail --&gt;|Aplica Filtro| Filter["WHERE orderNumber = 100"]
        Filter --&gt;|Muestra| Grid["Grilla de Productos"]
        Grid --&gt;|Nuevo Registro| NewLine["Formulario Detalle"]
        NewLine --&gt;|Campo Oculto| Hidden["orderNumber = 100"]
    end

    %% Estilos Profesionales
    classDef mainNode fill:#f9f,stroke:#333,stroke-width:2px;
    classDef detailNode fill:#bbf,stroke:#333,stroke-width:2px;
    classDef logicNode fill:#fff9c4,stroke:#fbc02d,stroke-width:2px;

    style Master fill:#e1bee7,stroke:#4a148c,stroke-width:2px
    style Detail fill:#bbdefb,stroke:#0d47a1,stroke-width:2px
    style Hidden fill:#c8e6c9,stroke:#2e7d32,stroke-dasharray: 5 5
</div>
<p>La idea b치sica es tener dos controladores:</p>
<ol>
<li><strong>El Maestro (Ordenes):</strong> Controla la informaci칩n general (fecha, cliente, total).</li>
<li><strong>El Detalle (OrdenesDetalles):</strong> Controla la lista de productos dentro de esa orden.</li>
</ol>
<hr/>
<h2 id="1-configurando-el-maestro-controlador-ordenes">1. Configurando el Maestro (Controlador <code>Ordenes</code>)</h2>
<p>Este es el "padre" de la relaci칩n. Aqu칤 definimos la cabecera de la factura.</p>
<ul>
<li><strong>Configuraci칩n b치sica:</strong> Le decimos a Ragnos que use la tabla <code>orders</code> y que la clave principal es <code>orderNumber</code>.</li>
<li><strong>Campos:</strong> Definimos los campos normales como fecha (<code>orderDate</code>), estado (<code>status</code>) y cliente (<code>customerNumber</code>).</li>
<li><strong>Campo Total (Calculado):</strong> Para mostrar el total de la orden sin guardarlo manualmente, usamos una peque침a consulta SQL dentro de la configuraci칩n del campo. Esta consulta suma <code>cantidad * precio</code> de la tabla de detalles.</li>
<li><strong>Activar el modo detalle:</strong>
  Hay una l칤nea clave que debes agregar en tu controlador maestro para avisar que tendr치 "hijos":
  <div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="x">$this-&gt;setDetailsController('Tienda\Ordenesdetalles');</span>
</code></pre></div>
  Esto le dice a Ragnos que el controlador <code>Ordenesdetalles</code> manejar치 los detalles relacionados con cada orden.
  La relaci칩n se basa en que el campo <code>orderNumber</code> en ambos controladores es el mismo, y este es la llave primaria en el maestro.</li>
</ul>
<h2 id="2-configurando-el-detalle-controlador-ordenesdetalles">2. Configurando el Detalle (Controlador <code>Ordenesdetalles</code>)</h2>
<p>Este es el "hijo". Controla cada l칤nea de producto.</p>
<ul>
<li><strong>El truco del campo oculto:</strong>
  Necesitamos que cada producto sepa a qu칠 orden pertenece. Para eso, en el campo <code>orderNumber</code> del detalle hacemos dos cosas:</li>
<li>Lo ponemos como <code>hidden</code> (oculto) para que el usuario no lo toque.</li>
<li>Le asignamos el valor por defecto <code>$this-&gt;master</code>.
     <em>쯈u칠 hace esto?</em> Cuando creas un detalle desde la orden #100, Ragnos autom치ticamente rellena este campo con el n칰mero 100.</li>
<li><strong>Filtrar los datos:</strong>
  No queremos ver <em>todos</em> los productos de <em>todas</em> las 칩rdenes. En el m칠todo <code>_filters()</code>, agregamos una regla para que solo se carguen los productos que coincidan con el ID del maestro actual (<code>$this-&gt;master</code>).</li>
</ul>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="x">function _filters()</span>
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="x">{</span>
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="x">    $this-&gt;modelo-&gt;builder()-&gt;where('orderNumber', $this-&gt;master);</span>
<a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="x">}</span>
</code></pre></div>
<p>En este fragmento, <code>$this-&gt;modelo-&gt;builder()</code> permite interactuar directamente con la consulta SQL que generar치 la grilla. La variable <code>$this-&gt;master</code> es inyectada autom치ticamente por el framework cuando detecta que este controlador se est치 ejecutando como "hijo", y contiene el ID del registro que se est치 visualizando en el maestro (en este caso, el n칰mero de orden).</p>
<ul>
<li><strong>Actualizar cambios:</strong>
  Usamos funciones especiales (llamadas <em>hooks</em>) como <code>_afterInsert</code> o <code>_afterUpdate</code> para limpiar la memoria cach칠. Esto asegura que si agregas un producto, el total de la orden principal se recalcule correctamente.
  游녤 <strong><a href="../../avanzado/hooks/">Ver Gu칤a de Hooks</a></strong></li>
</ul>
<h2 id="hooks-de-javascript-personalizados-opcional">Hooks de javascript personalizados (Opcional)</h2>
<p>En el archivo custom.js se ha agregado la siguiente funci칩n:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1">// con cada cambio en la tabla de detalles de ordenes</span>
<a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="c1">// recalcula el total de la orden</span>
<a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kd">function</span><span class="w"> </span><span class="nx">_OrdenesdetallesOnChange</span><span class="p">(</span><span class="nx">tabla</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">orden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">$</span><span class="p">(</span><span class="s2">"input[name='orderNumber']"</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
<a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="nx">getObject</span><span class="p">(</span><span class="s2">"tienda/ordenes/calculatotal"</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">orden</span><span class="o">:</span><span class="w"> </span><span class="nx">orden</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span><span class="nx">$</span><span class="p">(</span><span class="s1">'input[name="total"]'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">total</span><span class="p">);</span>
<a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">  </span><span class="p">});</span>
<a href="#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="p">}</span>
</code></pre></div>
<p>Esta funci칩n se ejecuta cada vez que hay un cambio en la tabla de detalles de 칩rdenes. Lo que hace es:</p>
<ol>
<li>Obtiene el n칰mero de orden actual desde el campo oculto.</li>
<li>Llama a un endpoint (<code>tienda/ordenes/calculatotal</code>) para recalcular el total de la orden.</li>
<li>Actualiza el campo <code>total</code> en la pantalla con el nuevo valor.</li>
</ol>
<p>de este modo, el total siempre estar치 actualizado, cada que se agregue, modifique o elimine un producto en la orden.</p>
<p>Esta funci칩n se enlaza autom치ticamente gracias a la convenci칩n de nombres: <code>_NombreDelControladorOnChange</code>.</p>
<h2 id="resumen-del-flujo-de-trabajo">Resumen del flujo de trabajo</h2>
<ol>
<li><strong>Abres una Orden:</strong> Ves los datos generales (Maestro).</li>
<li><strong>El sistema verifica:</strong> 쮼sta orden ya existe?</li>
<li><strong>S칤:</strong> Carga autom치ticamente la tabla de productos relacionados al final de la pantalla.</li>
<li><strong>No:</strong> Oculta la secci칩n de productos hasta que guardes la orden por primera vez.</li>
<li><strong>Agregas un producto:</strong> Al crear una l칤nea en la tabla de detalles, el sistema le pega invisiblemente el n칰mero de la orden padre.</li>
<li><strong>Guardas:</strong> Al guardar el detalle, el sistema actualiza los totales y todo se mantiene sincronizado.</li>
</ol>
<p>춰Y listo! Con estos pasos logras que dos tablas funcionen como una sola pantalla integrada.</p></div>
</div>
</div>
<footer class="col-md-12">
<hr/>
<p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
</footer>
<script src="../../../js/bootstrap.bundle.min.js"></script>
<script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
<script src="../../../js/base.js"></script>
<script src="../../../js/particles.js"></script>
<script src="../../../search/main.js"></script>
<div aria-hidden="true" aria-labelledby="searchModalLabel" class="modal" id="mkdocs_search_modal" role="dialog" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="searchModalLabel">Search</h4>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<p>From here you can search these documents. Enter your search terms below.</p>
<form>
<div class="form-group">
<input class="form-control" id="mkdocs-search-query" placeholder="Search..." title="Type search term here" type="search"/>
</div>
</form>
<div data-no-results-text="No results found" id="mkdocs-search-results"></div>
</div>
<div class="modal-footer">
</div>
</div>
</div>
</div><div aria-hidden="true" aria-labelledby="keyboardModalLabel" class="modal" id="mkdocs_keyboard_modal" role="dialog" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<table class="table">
<thead>
<tr>
<th style="width: 20%;">Keys</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td class="help shortcut"><kbd>?</kbd></td>
<td>Open this help</td>
</tr>
<tr>
<td class="next shortcut"><kbd>n</kbd></td>
<td>Next page</td>
</tr>
<tr>
<td class="prev shortcut"><kbd>p</kbd></td>
<td>Previous page</td>
</tr>
<tr>
<td class="search shortcut"><kbd>s</kbd></td>
<td>Search</td>
</tr>
</tbody>
</table>
</div>
<div class="modal-footer">
</div>
</div>
</div>
</div>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.6.1/dist/mermaid.esm.min.mjs";
mermaid.initialize({});</script></body>
</html>
