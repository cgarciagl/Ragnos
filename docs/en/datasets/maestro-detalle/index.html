<!DOCTYPE html>

<html data-bs-theme="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://cgarciagl.github.io/Ragnos/docs/en/datasets/maestro-detalle/" rel="canonical"/>
<link href="../../../img/favicon.ico" rel="shortcut icon"/>
<title>Master-Detail - Ragnos Docs</title>
<link href="../../../css/bootstrap.min.css" rel="stylesheet"/>
<link href="../../../css/fontawesome.min.css" rel="stylesheet"/>
<link href="../../../css/brands.min.css" rel="stylesheet"/>
<link href="../../../css/solid.min.css" rel="stylesheet"/>
<link href="../../../css/v4-font-face.min.css" rel="stylesheet"/>
<link href="../../../css/base.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/panda-syntax-dark.min.css" id="hljs-light" rel="stylesheet"/>
<link disabled="" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" id="hljs-dark" rel="stylesheet"/>
<link href="../../../css/ragnos_style.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
<!-- Google tag (gtag.js) -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-JGEDJD0GZP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag("js", new Date());

  gtag("config", "G-JGEDJD0GZP");
</script>
</head>
<body>
<div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
<div class="container">
<a class="navbar-brand" href="../../">Ragnos Docs</a>
<!-- Expander button -->
<button aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-bs-target="#navbar-collapse" data-bs-toggle="collapse" type="button">
<span class="navbar-toggler-icon"></span>
</button>
<!-- Expanded navigation -->
<div class="navbar-collapse collapse" id="navbar-collapse">
<!-- Main navigation -->
<ul class="nav navbar-nav">
<li class="nav-item">
<a class="nav-link" href="../../">Home</a>
</li>
<li class="nav-item dropdown">
<a aria-expanded="false" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button">Fundamentals</a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../../fundamentos/instalacion/">Installation</a>
</li>
<li>
<a class="dropdown-item" href="../../fundamentos/primeros_pasos/">Getting Started</a>
</li>
<li>
<a class="dropdown-item" href="../../fundamentos/configuracion/">Configuration</a>
</li>
<li>
<a class="dropdown-item" href="../../fundamentos/plantilla/">CLI Generator</a>
</li>
</ul>
</li>
<li class="nav-item dropdown">
<a aria-current="page" aria-expanded="false" class="nav-link dropdown-toggle active" data-bs-toggle="dropdown" href="#" role="button">Datasets &amp; Models</a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../datasets/">Creating Datasets</a>
</li>
<li>
<a class="dropdown-item" href="../campos/">Field Reference</a>
</li>
<li>
<a class="dropdown-item" href="../guia_RQueryController/">Advanced Queries (RQuery)</a>
</li>
<li>
<a aria-current="page" class="dropdown-item active" href="./">Master-Detail</a>
</li>
</ul>
</li>
<li class="nav-item dropdown">
<a aria-expanded="false" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button">Advanced Backend</a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../../avanzado/guia_modo_api/">API Mode</a>
</li>
<li>
<a class="dropdown-item" href="../../avanzado/helpers/">Helpers &amp; Utilities</a>
</li>
<li>
<a class="dropdown-item" href="../../avanzado/hooks/">Hooks &amp; Events</a>
</li>
<li>
<a class="dropdown-item" href="../../avanzado/autenticacion_integrada/">Authentication</a>
</li>
<li>
<a class="dropdown-item" href="../../avanzado/auditlog/">Audit Log</a>
</li>
<li>
<a class="dropdown-item" href="../../avanzado/server_side_events/">Server Side Events</a>
</li>
<li>
<a class="dropdown-item" href="../../avanzado/despliegue/">Deployment</a>
</li>
</ul>
</li>
<li class="nav-item dropdown">
<a aria-expanded="false" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button">Frontend &amp; Reports</a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../../frontend/personalizacion_ui/">UI Customization</a>
</li>
<li>
<a class="dropdown-item" href="../../frontend/reportes_simples/">Simple Reports</a>
</li>
<li>
<a class="dropdown-item" href="../../frontend/funciones_javascript/">JavaScript Functions</a>
</li>
</ul>
</li>
<li class="nav-item">
<a class="nav-link" href="https://ragnos.build">üè† Website</a>
</li>
</ul>
<ul class="nav navbar-nav ms-md-auto">
<li class="nav-item">
<a class="nav-link" data-bs-target="#mkdocs_search_modal" data-bs-toggle="modal" href="#">
<i class="fa fa-search"></i> Search
                            </a>
</li>
<li class="nav-item">
<a class="nav-link" href="../guia_RQueryController/" rel="prev">
<i class="fa fa-arrow-left"></i> Previous
                                </a>
</li>
<li class="nav-item">
<a class="nav-link" href="../../avanzado/guia_modo_api/" rel="next">
                                    Next <i class="fa fa-arrow-right"></i>
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="https://github.com/cgarciagl/ragnos"><i class="fa-brands fa-github"></i> GitHub</a>
</li>
</ul>
</div>
</div>
</div>
<div class="container">
<div class="row">
<div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
<div class="navbar-header">
<button class="navbar-toggler collapsed" data-bs-target="#toc-collapse" data-bs-toggle="collapse" title="Table of Contents" type="button">
<span class="fa fa-angle-down"></span>
</button>
</div>
<div class="navbar-collapse collapse card bg-body-tertiary" id="toc-collapse">
<ul class="nav flex-column">
<li class="nav-item" data-bs-level="1"><a class="nav-link" href="#master-detail-relationship-in-ragnos">üìë Master-Detail Relationship in Ragnos</a>
<ul class="nav flex-column">
<li class="nav-item" data-bs-level="2"><a class="nav-link" href="#relationship-architecture">Relationship Architecture</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-bs-level="2"><a class="nav-link" href="#1-configuring-the-master-orders-controller">1. Configuring the Master (Orders Controller)</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-bs-level="2"><a class="nav-link" href="#2-configuring-the-detail-orderdetails-controller">2. Configuring the Detail (OrderDetails Controller)</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-bs-level="2"><a class="nav-link" href="#custom-javascript-hooks-optional">Custom JavaScript Hooks (Optional)</a>
<ul class="nav flex-column">
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div></div>
<div class="col-md-9" role="main">
<h1 id="master-detail-relationship-in-ragnos">üìë Master-Detail Relationship in Ragnos</h1>
<p>This guide explains how to create a screen where you have a main record (like a <strong>Purchase Order</strong>) and a list of related items (the <strong>Details</strong> or products of that order).</p>
<h2 id="relationship-architecture">Relationship Architecture</h2>
<div class="mermaid">graph TD
    User["User"] --&gt;|Opens Screen| Master["Master Controller<br/>(Orders)"]
    Master --&gt;|Renders| View["Main View"]
    View --&gt;|Contains| Form["Master Form"]

    subgraph Linkage ["Linkage Logic"]
        direction TB
        Form --&gt;|"Order ID"| Logic{"Order Exists?"}
        Logic -- NO --&gt; Info("Only shows Form")
        Logic -- "YES (ID=100)" --&gt; LoadDetails["Load Detail Controller"]
    end

    LoadDetails --&gt;|"Injects ID=100 as $this-&gt;master"| Detail["Detail Controller<br/>(OrderDetails)"]

    subgraph Detail ["Detail Zone"]
        direction TB
        Detail --&gt;|Apply Filter| Filter["WHERE orderNumber = 100"]
        Filter --&gt;|Shows| Grid["Product Grid"]
        Grid --&gt;|New Record| NewLine["Detail Form"]
        NewLine --&gt;|Hidden Field| Hidden["orderNumber = 100"]
    end

    %% Professional Styles
    classDef mainNode fill:#f9f,stroke:#333,stroke-width:2px;
    classDef detailNode fill:#bbf,stroke:#333,stroke-width:2px;
    classDef logicNode fill:#fff9c4,stroke:#fbc02d,stroke-width:2px;

    style Master fill:#e1bee7,stroke:#4a148c,stroke-width:2px
    style Detail fill:#bbdefb,stroke:#0d47a1,stroke-width:2px
    style Hidden fill:#c8e6c9,stroke:#2e7d32,stroke-dasharray: 5 5
</div>
<p>The basic idea is to have two controllers:</p>
<ol>
<li><strong>The Master (Orders):</strong> Controls general information (date, customer, total).</li>
<li><strong>The Detail (OrderDetails):</strong> Controls the list of products within that order.</li>
</ol>
<hr/>
<h2 id="1-configuring-the-master-orders-controller">1. Configuring the Master (<code>Orders</code> Controller)</h2>
<p>This is the "parent" of the relationship. Here we define the invoice header.</p>
<ul>
<li><strong>Basic Configuration:</strong> We tell Ragnos to use the <code>orders</code> table and that the primary key is <code>orderNumber</code>.</li>
<li><strong>Fields:</strong> We define normal fields like date (<code>orderDate</code>), status (<code>status</code>), and customer (<code>customerNumber</code>).</li>
<li><strong>Total Field (Calculated):</strong> To show the order total without saving it manually, we use a small SQL query within the field configuration. This query sums <code>quantity * price</code> from the details table.</li>
<li><strong>Activate Detail Mode:</strong>
  There is a key line you must add to your master controller to warn that it will have "children":
  <div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="x">$this-&gt;setDetailsController('Store\OrderDetails');</span>
</code></pre></div>
  This tells Ragnos that the <code>OrderDetails</code> controller will handle the details related to each order.
  The relationship is based on the <code>orderNumber</code> field in both controllers being the same, and this is the primary key in the master.</li>
</ul>
<h2 id="2-configuring-the-detail-orderdetails-controller">2. Configuring the Detail (<code>OrderDetails</code> Controller)</h2>
<p>This is the "child". It controls each product line.</p>
<ul>
<li><strong>The Hidden Field Trick:</strong>
  We need each product to know which order it belongs to. For that, in the <code>orderNumber</code> field of the detail, we do two things:</li>
<li>We set it as <code>hidden</code> so the user doesn't touch it.</li>
<li>We assign the default value <code>$this-&gt;master</code>.
     <em>What does this do?</em> When you create a detail from order #100, Ragnos automatically fills this field with the number 100.</li>
<li><strong>Filter Data:</strong>
  We don't want to see <em>all</em> products from <em>all</em> orders. In the <code>_filters()</code> method, we add a rule so that only products matching the current master ID (<code>$this-&gt;master</code>) are loaded.</li>
</ul>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="x">function _filters()</span>
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="x">{</span>
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="x">    $this-&gt;modelo-&gt;builder()-&gt;where('orderNumber', $this-&gt;master);</span>
<a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="x">}</span>
</code></pre></div>
<p>In this snippet, <code>$this-&gt;modelo-&gt;builder()</code> allows you to interact directly with the SQL query that the grid will generate. The <code>$this-&gt;master</code> variable is automatically injected by the framework when it detects that this controller is running as a "child", and contains the ID of the record being viewed in the master (in this case, the order number).</p>
<ul>
<li><strong>Update Changes:</strong>
  We use special functions (called <em>hooks</em>) like <code>_afterInsert</code> or <code>_afterUpdate</code> to clear the cache. This ensures that if you add a product, the main order total is recalculated correctly.
  üëâ <strong><a href="../../avanzado/hooks/">See Hooks Guide</a></strong></li>
</ul>
<h2 id="custom-javascript-hooks-optional">Custom JavaScript Hooks (Optional)</h2>
<p>The following function has been added to the custom.js file:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1">// with every change in the order details table</span>
<a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="c1">// recalculate the order total</span>
<a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kd">function</span><span class="w"> </span><span class="nx">_OrderDetailsOnChange</span><span class="p">(</span><span class="nx">table</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">$</span><span class="p">(</span><span class="s2">"input[name='orderNumber']"</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
<a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="nx">getObject</span><span class="p">(</span><span class="s2">"store/orders/calculatetotal"</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">order</span><span class="o">:</span><span class="w"> </span><span class="nx">order</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span><span class="nx">$</span><span class="p">(</span><span class="s1">'input[name="total"]'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">total</span><span class="p">);</span>
<a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">  </span><span class="p">});</span>
<a href="#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="p">}</span>
</code></pre></div></div>
</div>
</div>
<footer class="col-md-12">
<hr/>
<p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
</footer>
<script src="../../../js/bootstrap.bundle.min.js"></script>
<script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
<script src="../../../js/base.js"></script>
<script src="../../../back_particles.js"></script>
<script src="../../../search/main.js"></script>
<div aria-hidden="true" aria-labelledby="searchModalLabel" class="modal" id="mkdocs_search_modal" role="dialog" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="searchModalLabel">Search</h4>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<p>From here you can search these documents. Enter your search terms below.</p>
<form>
<div class="form-group">
<input class="form-control" id="mkdocs-search-query" placeholder="Search..." title="Type search term here" type="search"/>
</div>
</form>
<div data-no-results-text="No results found" id="mkdocs-search-results"></div>
</div>
<div class="modal-footer">
</div>
</div>
</div>
</div><div aria-hidden="true" aria-labelledby="keyboardModalLabel" class="modal" id="mkdocs_keyboard_modal" role="dialog" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<table class="table">
<thead>
<tr>
<th style="width: 20%;">Keys</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td class="help shortcut"><kbd>?</kbd></td>
<td>Open this help</td>
</tr>
<tr>
<td class="next shortcut"><kbd>n</kbd></td>
<td>Next page</td>
</tr>
<tr>
<td class="prev shortcut"><kbd>p</kbd></td>
<td>Previous page</td>
</tr>
<tr>
<td class="search shortcut"><kbd>s</kbd></td>
<td>Search</td>
</tr>
</tbody>
</table>
</div>
<div class="modal-footer">
</div>
</div>
</div>
</div>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.6.1/dist/mermaid.esm.min.mjs";
mermaid.initialize({});</script></body>
</html>
