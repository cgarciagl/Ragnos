<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://cgarciagl.github.io/Ragnos/docs/en/avanzado/auditlog/">
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>Audit Log - Ragnos Docs</title>
        <link href="../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../../css/brands.min.css" rel="stylesheet">
        <link href="../../../css/solid.min.css" rel="stylesheet">
        <link href="../../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/panda-syntax-dark.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <link href="../../../css/ragnos_style.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script>
<!-- Google tag (gtag.js) -->
<script
  async
  src="https://www.googletagmanager.com/gtag/js?id=G-JGEDJD0GZP"
></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag("js", new Date());

  gtag("config", "G-JGEDJD0GZP");
</script>
  
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../">Ragnos Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../../" class="nav-link">Home</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Fundamentals</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../fundamentos/instalacion/" class="dropdown-item">Installation</a>
</li>
                                    
<li>
    <a href="../../fundamentos/primeros_pasos/" class="dropdown-item">Getting Started</a>
</li>
                                    
<li>
    <a href="../../fundamentos/configuracion/" class="dropdown-item">Configuration</a>
</li>
                                    
<li>
    <a href="../../fundamentos/plantilla/" class="dropdown-item">CLI Generator</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Datasets & Models</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../datasets/datasets/" class="dropdown-item">Creating Datasets</a>
</li>
                                    
<li>
    <a href="../../datasets/campos/" class="dropdown-item">Field Reference</a>
</li>
                                    
<li>
    <a href="../../datasets/guia_RQueryController/" class="dropdown-item">Advanced Queries (RQuery)</a>
</li>
                                    
<li>
    <a href="../../datasets/maestro-detalle/" class="dropdown-item">Master-Detail</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Advanced Backend</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../guia_modo_api/" class="dropdown-item">API Mode</a>
</li>
                                    
<li>
    <a href="../helpers/" class="dropdown-item">Helpers & Utilities</a>
</li>
                                    
<li>
    <a href="../hooks/" class="dropdown-item">Hooks & Events</a>
</li>
                                    
<li>
    <a href="../autenticacion_integrada/" class="dropdown-item">Authentication</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Audit Log</a>
</li>
                                    
<li>
    <a href="../server_side_events/" class="dropdown-item">Server Side Events</a>
</li>
                                    
<li>
    <a href="../despliegue/" class="dropdown-item">Deployment</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Frontend & Reports</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../frontend/personalizacion_ui/" class="dropdown-item">UI Customization</a>
</li>
                                    
<li>
    <a href="../../frontend/reportes_simples/" class="dropdown-item">Simple Reports</a>
</li>
                                    
<li>
    <a href="../../frontend/funciones_javascript/" class="dropdown-item">JavaScript Functions</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a href="https://ragnos.dev" class="nav-link">üè† Website</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../autenticacion_integrada/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../server_side_events/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/cgarciagl/ragnos" class="nav-link"><i class="fa-brands fa-github"></i> GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#audit-log" class="nav-link">Audit Log</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#configuration" class="nav-link">Configuration</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#internal-functioning" class="nav-link">Internal Functioning</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#logged-information" class="nav-link">Logged Information</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#user-detection-web-and-api" class="nav-link">User Detection (Web and API)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="audit-log">Audit Log</h1>
<p>Ragnos framework includes a native automatic system to log changes made to entity data. This system allows tracking who performed an action, when, from which IP address, and what specific data was modified, providing complete operation traceability.</p>
<h2 id="configuration">Configuration</h2>
<h3 id="usage-in-datasets-rdatasetcontroller">Usage in Datasets (RDatasetController)</h3>
<div class="admonition success">
<p class="admonition-title">Enabled by default</p>
<p>All classes extending <code>RDatasetController</code> have audit logging <strong>automatically enabled</strong>.</p>
</div>
<p>If you wish to <strong>disable</strong> audit for a specific dataset (e.g. temporary tables or massive movements not needing traceability), use <code>setEnableAudit(false)</code> method inside constructor.</p>
<p><strong>Example:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="x">class TemporaryLogs extends RDatasetController</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="x">{</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="x">    public function __construct()</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="x">    {</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="x">        parent::__construct();</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="x">        $this-&gt;setTableName(&#39;temp_logs&#39;);</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="x">        $this-&gt;setIdField(&#39;id&#39;);</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="x">        // ‚ùå Disable audit for this controller</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="x">        $this-&gt;setEnableAudit(false);</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="x">        // ... rest of config</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="x">    }</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="x">}</span>
</code></pre></div>
<h3 id="usage-in-manual-models">Usage in Manual Models</h3>
<p>To activate audit log in custom model (not managed by Dataset), property <code>$enableAudit</code> must be set to <code>true</code>. Model must use <code>CrudOperationsTrait</code> (or inherit from base class using it, like <code>RdatasetModel</code>).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="x">class CustomersModel extends RdatasetModel</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="x">{</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="x">    protected $table = &#39;customers&#39;;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="x">    protected $primaryKey = &#39;customer_id&#39;;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="x">    // Enable automatic audit for this entity</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="x">    protected $enableAudit = true;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="x">    // ... field definition</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="x">}</span>
</code></pre></div>
<p>By enabling this property, all insert, update, delete operations via controller/model will be intercepted and logged automatically without extra code in controllers.</p>
<h2 id="internal-functioning">Internal Functioning</h2>
<p>System works via <code>App\ThirdParty\Ragnos\Models\Traits\CrudOperationsTrait</code>. When write action executes, system performs steps transparently:</p>
<h3 id="1-insertion-insert">1. Insertion (INSERT)</h3>
<ul>
<li>Executed after record saved successfully.</li>
<li>Saves all new record data in log under key <code>new</code>.</li>
</ul>
<h3 id="2-update-update">2. Update (UPDATE)</h3>
<ul>
<li>Before saving, system compares current database values with sent new values.</li>
<li>Only if real differences exist, log save proceeds.</li>
<li><strong>Optimization</strong>: Logs JSON containing only changed fields, with old value (<code>old</code>) and new (<code>new</code>).</li>
</ul>
<p><em>Example saved JSON:</em></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="p">{</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span><span class="nt">&quot;old&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pending&quot;</span><span class="p">,</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="nt">&quot;new&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;active&quot;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">  </span><span class="p">},</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">  </span><span class="nt">&quot;credit_limit&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="nt">&quot;old&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1000.00&quot;</span><span class="p">,</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">    </span><span class="nt">&quot;new&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2500.00&quot;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="p">}</span>
</code></pre></div>
<h3 id="3-deletion-delete">3. Deletion (DELETE)</h3>
<ul>
<li>Before deleting physical record, system queries for current data.</li>
<li>Saves full copy of deleted record data under key <code>deleted_data</code> to allow historical query or manual restore.</li>
</ul>
<h2 id="logged-information">Logged Information</h2>
<p>For each event, <code>AuditLogModel</code> (table <code>gen_audit_logs</code>) stores:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>user_id</code></td>
<td>ID of user performing action. System resolves identity automatically by active session (Web) or Bearer Token (API).</td>
</tr>
<tr>
<td><code>table_name</code></td>
<td>Name of database table where change occurred.</td>
</tr>
<tr>
<td><code>record_id</code></td>
<td>ID (Primary Key) of affected record.</td>
</tr>
<tr>
<td><code>action</code></td>
<td>Operation type: <code>INSERT</code>, <code>UPDATE</code> or <code>DELETE</code>.</td>
</tr>
<tr>
<td><code>changes</code></td>
<td>Payload in JSON format with change details (see above). Stored with Unicode support for special characters.</td>
</tr>
<tr>
<td><code>ip_address</code></td>
<td>IP address originating request.</td>
</tr>
<tr>
<td><code>user_agent</code></td>
<td>Browser or HTTP client info used.</td>
</tr>
</tbody>
</table>
<h2 id="user-detection-web-and-api">User Detection (Web and API)</h2>
<p>Audit mechanism is agnostic to request origin. Method <code>getCurrentUserId()</code> resolves actor identity as follows:</p>
<ol>
<li><strong>Web Session:</strong> Checks if CodeIgniter session active (<code>session()-&gt;get('usu_id')</code>).</li>
<li><strong>API Token:</strong> If API call, inspects <code>Authorization</code> header. Extracts Bearer token and looks up user in <code>gen_usuarios</code>.</li>
<li><strong>Fallback:</strong> If user not identified, logs ID <code>0</code> (System/Anonymous).</li>
</ol></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js"></script>
        <script src="../../../back_particles.js"></script>
        <script src="../../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
